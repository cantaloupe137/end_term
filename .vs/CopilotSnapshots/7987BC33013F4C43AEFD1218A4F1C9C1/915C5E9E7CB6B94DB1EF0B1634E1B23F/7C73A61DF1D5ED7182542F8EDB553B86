using System.Runtime.CompilerServices;

namespace gravity
{
    public partial class Form1 : Form
    {
        private readonly PhysicsEngine physicsEngine;
        private readonly System.Windows.Forms.Timer gameTimer;
        private const int DEFAULT_SIZE = 35;
        private const int FRAME_INTERVAL = 16; // 約 60 FPS

        private bool is_drag = false;
        private Point Source; // 滑鼠當前位置
        private Point Destination; // 拖曳起始點
        private const float factor = 0.1f; // 給圖係數

        // 控制面板元件
        private Panel controlPanel;
        private TextBox offsetTextBox;
        private Label offsetLabel;
        private TrackBar gravityStrengthTrackBar;
        private Label gravityStrengthLabel;
        private TrackBar maxVelocityTrackBar;
        private Label maxVelocityLabel;
        private TrackBar particleSizeTrackBar;
        private Label particleSizeLabel;
        private TrackBar timeScaleTrackBar;
        private Label timeScaleLabel;
        private Button pauseButton;
        private Button clearButton;
        private Label statsLabel;

        private bool isPaused = false;
        private int currentParticleSize = DEFAULT_SIZE;

        public Form1()
        {
            InitializeComponent();
            this.BackColor = Color.Black;
            this.DoubleBuffered = true;

            // 設定視窗大小為 1920x1080 (16:9)
            this.ClientSize = new Size(1920, 1080);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.Text = "重力模擬系統 - 1920x1080";

            physicsEngine = new PhysicsEngine();

            gameTimer = new System.Windows.Forms.Timer();
            gameTimer.Interval = FRAME_INTERVAL;
            gameTimer.Tick += GameTimer_Tick;
            gameTimer.Start();

            InitializeControlPanel();
        }

        private void InitializeControlPanel()
        {
            // 創建控制面板容器
            controlPanel = new Panel
            {
                BackColor = Color.FromArgb(200, 30, 30, 30),
                Width = 280,
                Height = 520,
                Location = new Point(10, 10),
                Padding = new Padding(10)
            };
            this.Controls.Add(controlPanel);

            int yPosition = 10;
            int labelHeight = 20;
            int trackBarHeight = 45;
            int textBoxHeight = 30;
            int labelToControlSpacing = 5;  // Label 到控制項的間距
            int sectionSpacing = 15;         // 每個區塊之間的間距

            // === 位置偏移範圍 ===
            offsetLabel = new Label
            {
                Text = "位置偏移範圍: 0.0",
                ForeColor = Color.White,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition)
            };
            controlPanel.Controls.Add(offsetLabel);
            yPosition += labelHeight + labelToControlSpacing;

            offsetTextBox = new TextBox
            {
                Text = "0.0",
                Width = 260,
                Location = new Point(10, yPosition),
                BackColor = Color.White,
                ForeColor = Color.Black
            };
            offsetTextBox.TextChanged += (s, e) => UpdateOffsetLabel();
            controlPanel.Controls.Add(offsetTextBox);
            yPosition += textBoxHeight + sectionSpacing;

            // === 重力強度 ===
            gravityStrengthLabel = new Label
            {
                Text = "重力強度: 30.0",
                ForeColor = Color.White,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition)
            };
            controlPanel.Controls.Add(gravityStrengthLabel);
            yPosition += labelHeight + labelToControlSpacing;

            gravityStrengthTrackBar = new TrackBar
            {
                Minimum = 0,
                Maximum = 100,
                Value = 30,
                TickFrequency = 10,
                Width = 260,
                Location = new Point(10, yPosition)
            };
            gravityStrengthTrackBar.ValueChanged += GravityStrengthTrackBar_ValueChanged;
            controlPanel.Controls.Add(gravityStrengthTrackBar);
            yPosition += trackBarHeight + sectionSpacing;

            // === 最大速度 ===
            maxVelocityLabel = new Label
            {
                Text = "最大速度: 100.0",
                ForeColor = Color.White,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition)
            };
            controlPanel.Controls.Add(maxVelocityLabel);
            yPosition += labelHeight + labelToControlSpacing;

            maxVelocityTrackBar = new TrackBar
            {
                Minimum = 10,
                Maximum = 300,
                Value = 100,
                TickFrequency = 50,
                Width = 260,
                Location = new Point(10, yPosition)
            };
            maxVelocityTrackBar.ValueChanged += MaxVelocityTrackBar_ValueChanged;
            controlPanel.Controls.Add(maxVelocityTrackBar);
            yPosition += trackBarHeight + sectionSpacing;

            // === 粒子大小 ===
            particleSizeLabel = new Label
            {
                Text = "粒子大小: 35",
                ForeColor = Color.White,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition)
            };
            controlPanel.Controls.Add(particleSizeLabel);
            yPosition += labelHeight + labelToControlSpacing;

            particleSizeTrackBar = new TrackBar
            {
                Minimum = 10,
                Maximum = 100,
                Value = DEFAULT_SIZE,
                TickFrequency = 10,
                Width = 260,
                Location = new Point(10, yPosition)
            };
            particleSizeTrackBar.ValueChanged += ParticleSizeTrackBar_ValueChanged;
            controlPanel.Controls.Add(particleSizeTrackBar);
            yPosition += trackBarHeight + sectionSpacing;

            // === 時間縮放 ===
            timeScaleLabel = new Label
            {
                Text = "時間縮放: 1.0x",
                ForeColor = Color.White,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition)
            };
            controlPanel.Controls.Add(timeScaleLabel);
            yPosition += labelHeight + labelToControlSpacing;

            timeScaleTrackBar = new TrackBar
            {
                Minimum = 1,
                Maximum = 50,
                Value = 10,
                TickFrequency = 5,
                Width = 260,
                Location = new Point(10, yPosition)
            };
            timeScaleTrackBar.ValueChanged += TimeScaleTrackBar_ValueChanged;
            controlPanel.Controls.Add(timeScaleTrackBar);
            yPosition += trackBarHeight + sectionSpacing;

            // === 按鈕區域 ===
            pauseButton = new Button
            {
                Text = "暫停",
                Width = 125,
                Height = 35,
                Location = new Point(10, yPosition),
                BackColor = Color.FromArgb(70, 70, 70),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat
            };
            pauseButton.Click += PauseButton_Click;
            controlPanel.Controls.Add(pauseButton);

            clearButton = new Button
            {
                Text = "清除全部",
                Width = 125,
                Height = 35,
                Location = new Point(145, yPosition),
                BackColor = Color.FromArgb(70, 70, 70),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat
            };
            clearButton.Click += ClearButton_Click;
            controlPanel.Controls.Add(clearButton);
            yPosition += 45;

            // === 統計資訊 ===
            statsLabel = new Label
            {
                Text = "粒子: 0 | 重力源: 0",
                ForeColor = Color.Lime,
                AutoSize = false,
                Width = 260,
                Height = 40,
                Location = new Point(10, yPosition),
                Font = new Font("Consolas", 9, FontStyle.Bold)
            };
            controlPanel.Controls.Add(statsLabel);

            controlPanel.BringToFront();
        }

        private void UpdateOffsetLabel()
        {
            double offset = GetOffsetValue();
            offsetLabel.Text = $"位置偏移範圍: {offset:F1}";
        }

        private void GravityStrengthTrackBar_ValueChanged(object sender, EventArgs e)
        {
            double value = gravityStrengthTrackBar.Value;
            physicsEngine.GravityStrength = value;
            gravityStrengthLabel.Text = $"重力強度: {value:F1}";
        }

        private void MaxVelocityTrackBar_ValueChanged(object sender, EventArgs e)
        {
            double value = maxVelocityTrackBar.Value;
            physicsEngine.MaxVelocity = value;
            maxVelocityLabel.Text = $"最大速度: {value:F1}";
        }

        private void ParticleSizeTrackBar_ValueChanged(object sender, EventArgs e)
        {
            currentParticleSize = particleSizeTrackBar.Value;
            particleSizeLabel.Text = $"粒子大小: {currentParticleSize}";
        }

        private void TimeScaleTrackBar_ValueChanged(object sender, EventArgs e)
        {
            double timeScale = timeScaleTrackBar.Value / 10.0;
            physicsEngine.TimeScale = timeScale;
            timeScaleLabel.Text = $"時間縮放: {timeScale:F1}x";
        }

        private void PauseButton_Click(object sender, EventArgs e)
        {
            isPaused = !isPaused;
            pauseButton.Text = isPaused ? "繼續" : "暫停";
            pauseButton.BackColor = isPaused ? Color.FromArgb(100, 50, 50) : Color.FromArgb(70, 70, 70);
        }

        private void ClearButton_Click(object sender, EventArgs e)
        {
            physicsEngine.Clear();
            this.Invalidate();
        }

        private double GetOffsetValue()
        {
            if (double.TryParse(offsetTextBox.Text, out double offset))
            {
                return Math.Abs(offset);
            }
            return 0.0;
        }

        protected override void OnMouseDown(MouseEventArgs e)
        {
            base.OnMouseDown(e);
            
            // 檢查是否點擊在控制面板上
            if (controlPanel.Bounds.Contains(e.Location))
            {
                return;
            }

            if (e.Button == MouseButtons.Left)
            {
                Destination = e.Location;
                is_drag = true;
            }
            else if (e.Button == MouseButtons.Right)
            {
                physicsEngine.AddBlock(e.X, e.Y, currentParticleSize);
                this.Invalidate();
            }
        }

        protected override void OnMouseMove(MouseEventArgs e)
        {
            base.OnMouseMove(e);
            if (is_drag)
            {
                Source = e.Location;
                // 只重繪拖曳區域,減少渲染負擔
                this.Invalidate();
            }
        }

        protected override void OnMouseUp(MouseEventArgs e)
        {
            base.OnMouseUp(e);
            if (e.Button == MouseButtons.Left && is_drag)
            {
                is_drag = false;

                double velocityX = (Destination.X - Source.X) * factor;
                double velocityY = (Destination.Y - Source.Y) * factor;
                double positionX = Source.X;
                double positionY = Source.Y;
                double offset = GetOffsetValue();

                if (offset > 0)
                {
                    physicsEngine.AddBallWithVelocityAndOffset(positionX, positionY, currentParticleSize, velocityX, velocityY, offset);
                }
                else
                {
                    physicsEngine.AddBallWithVelocity(positionX, positionY, currentParticleSize, velocityX, velocityY);
                }

                this.Invalidate();
            }
        }

        private void GameTimer_Tick(object sender, EventArgs e)
        {
            if (!isPaused)
            {
                physicsEngine.Update(this.ClientSize.Width, this.ClientSize.Height);
            }
            
            // 更新統計資訊
            statsLabel.Text = $"粒子: {physicsEngine.BallCount} | 重力源: {physicsEngine.BlockCount}";
            
            this.Invalidate();
        }

        protected override void OnPaint(PaintEventArgs e)
        {
            base.OnPaint(e);
            
            // 啟用抗鋸齒,讓拖曳線更平滑
            e.Graphics.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            
            physicsEngine.Draw(e.Graphics);

            // 繪製拖曳軌跡線
            if (is_drag)
            {
                using (Pen whitePen = new Pen(Color.White, 2))
                {
                    e.Graphics.DrawLine(whitePen, Destination, Source);
                    e.Graphics.DrawEllipse(whitePen, Destination.X - 3, Destination.Y - 3, 6, 6);
                }
            }
        }

        private void Form1_DragDrop(object sender, DragEventArgs e)
        {
            // 拖放事件處理邏輯
        }

        private void Form1_MouseClick(object sender, MouseEventArgs e)
        {
            // 滑鼠點擊事件處理邏輯
        }
    }
}
