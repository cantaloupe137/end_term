using System.Runtime.CompilerServices;
using System.Media;

namespace gravity
{
    public partial class Form1 : Form
    {
        private readonly PhysicsEngine physicsEngine;
        private readonly System.Windows.Forms.Timer gameTimer;
        private const int DEFAULT_SIZE = 35;
        private const int FRAME_INTERVAL = 16; // 約 60 FPS

        // 控制面板元件
        private Panel controlPanel;
        private TrackBar gravityStrengthTrackBar;
        private Label gravityStrengthLabel;
        private TrackBar maxVelocityTrackBar;
        private Label maxVelocityLabel;
        private TrackBar particleSizeTrackBar;
        private Label particleSizeLabel;
        private TrackBar timeScaleTrackBar;
        private Label timeScaleLabel;
        private TrackBar repulsionStrengthTrackBar;
        private Label repulsionStrengthLabel;
        private Button pauseButton;
        private Button clearButton;
        private Label statsLabel;
        private CheckBox repulsionCheckBox;
        private CheckBox gravityFieldCheckBox;
        private Label fpsLabel;
        private Label helpLabel;

        private bool isPaused = false;
        private int currentParticleSize = DEFAULT_SIZE;
        private bool enableSound = true;

        public Form1()
        {
            InitializeComponent();
            this.BackColor = Color.Black;
            this.DoubleBuffered = true;

            this.ClientSize = new Size(1920, 1080);
            this.StartPosition = FormStartPosition.CenterScreen;
            this.Text = "重力模擬系統 - 1920x1080";

            physicsEngine = new PhysicsEngine();
            
            // 訂閱爆炸事件
            physicsEngine.ExplosionOccurred += PhysicsEngine_ExplosionOccurred;

            gameTimer = new System.Windows.Forms.Timer();
            gameTimer.Interval = FRAME_INTERVAL;
            gameTimer.Tick += GameTimer_Tick;
            gameTimer.Start();

            InitializeControlPanel();
        }

        private void PhysicsEngine_ExplosionOccurred(object sender, EventArgs e)
        {
            if (enableSound)
            {
                PlayExplosionSound();
            }
        }

        private void PlayExplosionSound()
        {
            try
            {
                // 使用系統提示音作為爆炸音效
                // 你可以替換成自己的 .wav 音效檔
                SystemSounds.Beep.Play();
                
                // 如果要使用自訂音效檔,取消註解下面這行:
                // SoundPlayer player = new SoundPlayer("explosion.wav");
                // player.Play();
            }
            catch
            {
                // 如果音效播放失敗,靜默處理
            }
        }

        private void InitializeControlPanel()
        {
            controlPanel = new Panel
            {
                BackColor = Color.FromArgb(200, 30, 30, 30),
                Width = 280,
                Height = 570,
                Location = new Point(10, 10),
                Padding = new Padding(10),
                AutoScroll = true
            };
            this.Controls.Add(controlPanel);

            int yPosition = 10;
            int labelHeight = 20;
            int trackBarHeight = 45;
            int labelToControlSpacing = 5;
            int sectionSpacing = 15;

            // === FPS 顯示 ===
            fpsLabel = new Label
            {
                Text = "FPS: 60.0",
                ForeColor = Color.Lime,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition),
                Font = new Font("Consolas", 10, FontStyle.Bold)
            };
            controlPanel.Controls.Add(fpsLabel);
            yPosition += labelHeight + sectionSpacing;

            // === 重力強度 ===
            gravityStrengthLabel = new Label
            {
                Text = "重力強度: 30.0",
                ForeColor = Color.White,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition)
            };
            controlPanel.Controls.Add(gravityStrengthLabel);
            yPosition += labelHeight + labelToControlSpacing;

            gravityStrengthTrackBar = new TrackBar
            {
                Minimum = 0,
                Maximum = 100,
                Value = 30,
                TickFrequency = 10,
                Width = 260,
                Location = new Point(10, yPosition)
            };
            gravityStrengthTrackBar.ValueChanged += GravityStrengthTrackBar_ValueChanged;
            controlPanel.Controls.Add(gravityStrengthTrackBar);
            yPosition += trackBarHeight + sectionSpacing;

            // === 最大速度 ===
            maxVelocityLabel = new Label
            {
                Text = "最大速度: 100.0",
                ForeColor = Color.White,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition)
            };
            controlPanel.Controls.Add(maxVelocityLabel);
            yPosition += labelHeight + labelToControlSpacing;

            maxVelocityTrackBar = new TrackBar
            {
                Minimum = 10,
                Maximum = 300,
                Value = 100,
                TickFrequency = 50,
                Width = 260,
                Location = new Point(10, yPosition)
            };
            maxVelocityTrackBar.ValueChanged += MaxVelocityTrackBar_ValueChanged;
            controlPanel.Controls.Add(maxVelocityTrackBar);
            yPosition += trackBarHeight + sectionSpacing;

            // === 粒子大小 ===
            particleSizeLabel = new Label
            {
                Text = "粒子大小: 35",
                ForeColor = Color.White,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition)
            };
            controlPanel.Controls.Add(particleSizeLabel);
            yPosition += labelHeight + labelToControlSpacing;

            particleSizeTrackBar = new TrackBar
            {
                Minimum = 10,
                Maximum = 100,
                Value = DEFAULT_SIZE,
                TickFrequency = 10,
                Width = 260,
                Location = new Point(10, yPosition)
            };
            particleSizeTrackBar.ValueChanged += ParticleSizeTrackBar_ValueChanged;
            controlPanel.Controls.Add(particleSizeTrackBar);
            yPosition += trackBarHeight + sectionSpacing;

            // === 時間縮放 ===
            timeScaleLabel = new Label
            {
                Text = "時間縮放: 1.0x",
                ForeColor = Color.White,
                AutoSize = false,
                Width = 260,
                Height = labelHeight,
                Location = new Point(10, yPosition)
            };
            controlPanel.Controls.Add(timeScaleLabel);
            yPosition += labelHeight + labelToControlSpacing;

            timeScaleTrackBar = new TrackBar
            {
                Minimum = 1,
                Maximum = 50,
                Value = 10,
                TickFrequency = 5,
                Width = 260,
                Location = new Point(10, yPosition)
            };
            timeScaleTrackBar.ValueChanged += TimeScaleTrackBar_ValueChanged;
            controlPanel.Controls.Add(timeScaleTrackBar);
            yPosition += trackBarHeight + sectionSpacing;

            // === 排斥力檢測 ===
            repulsionCheckBox = new CheckBox
            {
                Text = "啟用排斥力檢測",
                ForeColor = Color.White,
                AutoSize = true,
                Checked = false,
                Location = new Point(10, yPosition)
            };
            repulsionCheckBox.CheckedChanged += (s, e) => physicsEngine.EnableRepulsion = repulsionCheckBox.Checked;
            controlPanel.Controls.Add(repulsionCheckBox);
            yPosition += 25 + sectionSpacing;

            // === 重力場視覺化 ===
            gravityFieldCheckBox = new CheckBox
            {
                Text = "顯示重力場 (綠色箭頭)",
                ForeColor = Color.White,
                AutoSize = true,
                Checked = false,
                Location = new Point(10, yPosition)
            };
            gravityFieldCheckBox.CheckedChanged += (s, e) => physicsEngine.ShowGravityField = gravityFieldCheckBox.Checked;
            controlPanel.Controls.Add(gravityFieldCheckBox);
            yPosition += 25 + sectionSpacing;

            // === 按鈕區域 ===
            pauseButton = new Button
            {
                Text = "暫停",
                Width = 125,
                Height = 35,
                Location = new Point(10, yPosition),
                BackColor = Color.FromArgb(70, 70, 70),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat
            };
            pauseButton.Click += PauseButton_Click;
            controlPanel.Controls.Add(pauseButton);

            clearButton = new Button
            {
                Text = "清除全部",
                Width = 125,
                Height = 35,
                Location = new Point(145, yPosition),
                BackColor = Color.FromArgb(70, 70, 70),
                ForeColor = Color.White,
                FlatStyle = FlatStyle.Flat
            };
            clearButton.Click += ClearButton_Click;
            controlPanel.Controls.Add(clearButton);
            yPosition += 45;

            // === 統計資訊 ===
            statsLabel = new Label
            {
                Text = "粒子: 0 | 重力源: 0",
                ForeColor = Color.Lime,
                AutoSize = false,
                Width = 260,
                Height = 30,
                Location = new Point(10, yPosition),
                Font = new Font("Consolas", 9, FontStyle.Bold)
            };
            controlPanel.Controls.Add(statsLabel);
            yPosition += 35;

            // === 操作說明 ===
            helpLabel = new Label
            {
                Text = "操作說明:\n" +
                       "• 左鍵: 創建粒子\n" +
                       "• 右鍵: 創建重力源\n" +
                       "• 空白鍵: 暫停/繼續\n" +
                       "• 球高速碰撞時播放音效並銷毀\n" +
                       "• 球不會與重力源碰撞",
                ForeColor = Color.Yellow,
                AutoSize = false,
                Width = 260,
                Height = 110,
                Location = new Point(10, yPosition),
                Font = new Font("Consolas", 8, FontStyle.Regular)
            };
            controlPanel.Controls.Add(helpLabel);

            controlPanel.BringToFront();
        }

        private void GravityStrengthTrackBar_ValueChanged(object sender, EventArgs e)
        {
            double value = gravityStrengthTrackBar.Value;
            physicsEngine.GravityStrength = value;
            gravityStrengthLabel.Text = $"重力強度: {value:F1}";
        }

        private void MaxVelocityTrackBar_ValueChanged(object sender, EventArgs e)
        {
            double value = maxVelocityTrackBar.Value;
            physicsEngine.MaxVelocity = value;
            maxVelocityLabel.Text = $"最大速度: {value:F1}";
        }

        private void ParticleSizeTrackBar_ValueChanged(object sender, EventArgs e)
        {
            currentParticleSize = particleSizeTrackBar.Value;
            particleSizeLabel.Text = $"粒子大小: {currentParticleSize}";
        }

        private void TimeScaleTrackBar_ValueChanged(object sender, EventArgs e)
        {
            double timeScale = timeScaleTrackBar.Value / 10.0;
            physicsEngine.TimeScale = timeScale;
            timeScaleLabel.Text = $"時間縮放: {timeScale:F1}x";
        }

        private void PauseButton_Click(object sender, EventArgs e)
        {
            isPaused = !isPaused;
            pauseButton.Text = isPaused ? "繼續" : "暫停";
            pauseButton.BackColor = isPaused ? Color.FromArgb(100, 50, 50) : Color.FromArgb(70, 70, 70);
        }

        private void ClearButton_Click(object sender, EventArgs e)
        {
            physicsEngine.Clear();
            this.Invalidate();
        }

        protected override void OnMouseDown(MouseEventArgs e)
        {
            base.OnMouseDown(e);
            
            if (controlPanel.Bounds.Contains(e.Location))
            {
                return;
            }

            if (e.Button == MouseButtons.Left)
            {
                physicsEngine.AddBallWithVelocity(e.X, e.Y, currentParticleSize, 0, 0);
                this.Invalidate();
            }
            else if (e.Button == MouseButtons.Right)
            {
                physicsEngine.AddBlock(e.X, e.Y, currentParticleSize);
                this.Invalidate();
            }
        }

        protected override void OnKeyDown(KeyEventArgs e)
        {
            base.OnKeyDown(e);
            
            if (e.KeyCode == Keys.Space)
            {
                PauseButton_Click(null, null);
            }
        }

        private void GameTimer_Tick(object sender, EventArgs e)
        {
            if (!isPaused)
            {
                physicsEngine.Update(this.ClientSize.Width, this.ClientSize.Height);
            }
            
            statsLabel.Text = $"粒子: {physicsEngine.BallCount} | 重力源: {physicsEngine.BlockCount}";
            fpsLabel.Text = $"FPS: {physicsEngine.CurrentFPS:F1}";
            
            this.Invalidate();
        }

        protected override void OnPaint(PaintEventArgs e)
        {
            base.OnPaint(e);
            e.Graphics.SmoothingMode = System.Drawing.Drawing2D.SmoothingMode.AntiAlias;
            physicsEngine.Draw(e.Graphics);
        }
    }
}
